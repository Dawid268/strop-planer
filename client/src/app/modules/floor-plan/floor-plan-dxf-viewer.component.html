<div
  class="viewer-container flex flex-column h-full bg-900 text-0 font-sans overflow-hidden"
>
  <p-toolbar
    styleClass="bg-800 border-none border-bottom-1 border-700 p-2 gap-3 flex-wrap"
  >
    <div class="p-toolbar-group-start gap-3">
      <div class="upload-section">
        <input
          type="file"
          accept=".pdf,.dxf"
          (change)="onFileSelected($event)"
          #fileInput
          id="file-upload"
          hidden
        />
        <p-button
          label="Wybierz PDF lub DXF"
          icon="pi pi-file-pdf"
          (click)="fileInput.click()"
          severity="primary"
        ></p-button>

        @if (uploadProgress() > 0 && uploadProgress() < 100) {
          <p-progressBar
            [value]="uploadProgress()"
            [showValue]="false"
            styleClass="w-10rem h-1rem mt-2"
          ></p-progressBar>
        }
      </div>

      @if (currentDocument()) {
        <div
          class="document-info flex align-items-center gap-3 bg-700 px-3 py-2 border-round font-mono text-sm"
        >
          <span>{{ currentDocument()!.documentId }}</span>
          <p-button
            icon="pi pi-times"
            [text]="true"
            severity="danger"
            (click)="clearDocument()"
            size="small"
          ></p-button>
        </div>

        <div
          class="layer-controls flex align-items-center gap-3 flex-wrap border-left-1 border-600 pl-3"
        >
          <span class="text-sm text-400">Warstwy:</span>
          @for (layer of layers(); track layer) {
            <div class="flex align-items-center gap-2">
              <p-checkbox
                [binary]="true"
                [ngModel]="isLayerVisible(layer)"
                (onChange)="toggleLayer(layer)"
                [inputId]="'layer-' + layer"
              ></p-checkbox>
              <label
                [for]="'layer-' + layer"
                class="text-xs cursor-pointer select-none"
                >{{ layer }}</label
              >
            </div>
          }
        </div>
      }
    </div>

    <div class="p-toolbar-group-end gap-2">
      @if (currentDocument()) {
        <p-button
          [icon]="isSelectionMode() ? 'pi pi-mouse' : 'pi pi-cursor'"
          [severity]="isSelectionMode() ? 'primary' : 'secondary'"
          [outlined]="!isSelectionMode()"
          (click)="toggleSelectionMode()"
          pTooltip="Tryb wybierania (kliknij linię)"
          tooltipPosition="bottom"
          label="Wybierz"
        ></p-button>

        @if (selectedEntity()) {
          <p-button
            icon="pi pi-check"
            severity="success"
            (click)="useSelectedAsSlab()"
            label="Użyj jako obrys"
            pTooltip="Ustaw zaznaczony element jako strop"
            tooltipPosition="bottom"
          ></p-button>
        }

        <p-button
          icon="pi pi-target"
          (click)="resetCamera()"
          pTooltip="Reset widoku"
          tooltipPosition="bottom"
          [outlined]="true"
          severity="secondary"
        ></p-button>
        <p-button
          icon="pi pi-expand"
          (click)="fitToView()"
          pTooltip="Dopasuj do widoku"
          tooltipPosition="bottom"
          [outlined]="true"
          severity="secondary"
        ></p-button>
        <p-button
          [icon]="showGrid() ? 'pi pi-th-large' : 'pi pi-table'"
          (click)="toggleGrid()"
          pTooltip="Siatka"
          tooltipPosition="bottom"
          [outlined]="!showGrid()"
          [severity]="showGrid() ? 'primary' : 'secondary'"
        ></p-button>
      }
    </div>
  </p-toolbar>

  <main class="viewer-main flex-grow-1 relative overflow-hidden bg-900">
    @if (isLoading()) {
      <div
        class="loading absolute inset-0 z-10 flex flex-column align-items-center justify-content-center bg-black-alpha-70"
      >
        <p-progressSpinner
          styleClass="w-4rem h-4rem"
          strokeWidth="4"
        ></p-progressSpinner>
        <p class="mt-3 text-lg font-medium">Przetwarzanie pliku...</p>
      </div>
    }
    @if (error()) {
      <div
        class="error absolute inset-0 z-10 flex flex-column align-items-center justify-content-center bg-black-alpha-70 text-center p-4"
      >
        <i class="pi pi-exclamation-triangle text-6xl text-red-500 mb-4"></i>
        <h3 class="m-0 text-2xl font-bold text-red-500">Błąd</h3>
        <p class="mt-2 text-lg">{{ error() }}</p>
        <p-button
          label="Spróbuj ponownie"
          (click)="clearError()"
          class="mt-4"
          severity="secondary"
          [outlined]="true"
        ></p-button>
      </div>
    }

    <div #canvasContainer class="canvas-container w-full h-full"></div>

    @if (currentDocument()) {
      <div
        class="stats absolute bottom-0 left-0 m-3 p-3 bg-black-alpha-60 border-round shadow-2 flex gap-4 text-xs font-mono text-300"
      >
        <div class="flex align-items-center gap-2">
          <i class="pi pi-layers"></i>
          <span>Warstw: {{ layers().length }}</span>
        </div>
        <div class="flex align-items-center gap-2">
          <i class="pi pi-database"></i>
          <span>Elementów: {{ entityCount() }}</span>
        </div>
      </div>
    }
  </main>
</div>
